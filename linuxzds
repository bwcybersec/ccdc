#!/bin/bash

# Backup configs
mkdir /var/zds
mkdir /var/zds/timezone
cp -r /etc /var/zds/etc_backup

if type apt-get &>/dev/null
then
    # Are we on old Debian-based
    if [[ -f /etc/lsb-release ]]
    then
        . /etc/lsb-release
        # Are we on precise?
        if [$DISTRIB_CODENAME = "precise"]
        then
            pushd /etc/apt
            mv sources.list sources.list.bak
            cat  <<EOF
deb http://old-releases.ubuntu.com/ubuntu/ precise main restricted universe multiverse
deb-src http://old-releases.ubuntu.com/ubuntu/ precise main restricted universe multiverse
deb http://old-releases.ubuntu.com/ubuntu/ precise-updates main restricted universe multiverse
deb-src http://old-releases.ubuntu.com/ubuntu/ precise-updates main restricted universe multiverse
deb http://old-releases.ubuntu.com/ubuntu/ precise-backports main restricted universe multiverse
deb-src http://old-releases.ubuntu.com/ubuntu/ precise-backports main restricted universe multiverse
deb http://old-releases.ubuntu.com/ubuntu/ precise-security main restricted universe multiverse
deb-src http://old-releases.ubuntu.com/ubuntu/ precise-security main restricted universe multiverse
EOF
        fi
    fi
    
    expected_dist=apt
    apt-get install curl openssh-server vim snmpd clamav nmap auditd curl debsums
else
    expected_dist=rpm
    if grep --quiet 'ID=\"centos\"' /etc/os-release || [[ -f /etc/centos-release ]]; then
        yum install -y epel-release
    fi
    yum install -y vim openssh-server clamav curl net-snmp nmap audit
fi

# Set user passwords and sweep keys
mkdir -p /var/zds/bash_hist
mkdir -p /var/zds/auth_keys
mkdir -p /var/log/zds

if [[ -e /root ]]
then
    mv -f /root/.bash_history /var/zds/bash_hist/bash_history_ir_root 2> /dev/null
    mv -f /foot/.ssh/authorized_keys /var/zds/auth_keys/root.authorized_keys 2> /dev/null
fi
if [[ -e /home/sysadmin ]]
then
    admin_user="sysadmin"
    mv -f "/home/$admin_user/.bash_history" /var/zds/bash_hist/bash_history_ir 2> /dev/null
    mv -f "/home/$admin_user/.ssh/authorized_keys" "/var/zds/auth_keys/$admin_user.authorized_keys" 2> /dev/null
fi
if [[ -e /home/admin ]]
then
    admin_user="admin"
    mv -f "/home/$admin_user/.bash_history" /var/log/bash_hist/bash_history_ir 2> /dev/null
    mv -f "/home/$admin_user/.ssh/authorized_keys" "/var/zds/auth_keys/$admin_user.authorized_keys" 2> /dev/null
fi
if [[ -e /home/administrator ]]
then
    admin_user="administrator"
    mv -f "/home/$admin_user/.bash_history" /var/log/bash_hist/bash_history_ir 2> /dev/null
    mv -f "/home/$admin_user/.ssh/authorized_keys" "/var/zds/auth_keys/$admin_user.authorized_keys" 2> /dev/null
fi

chmod 700 /var/log/bash_hist
chmod 700 /var/log/auth_keys

# No root login ssh
sed -i 's/#\?\(PermitRootLogin\s*\).*$/\1 no/' /etc/ssh/sshd_config

# Disable other firewalls
if [[ "$expected_dist" == "rpm" ]]; then
yum list installed firewalld && systemctl disable --now firewalld
elif [[ "$expected_dist" == "apt" ]]; then
service ufw status && systemctl disable --now ufw
fi

# no red team bad red team
# chattr -i /etc/group /etc/shadow /etc/passwd
chown root:root /etc/group
if [ $(getent group shadow) ]; then
chown root:shadow /etc/shadow
else
chown root:root /etc/shadow
fi
chown root:root /etc/passwd
chown root:root /etc/sudoers

netstat -an | grep LISTEN | tee netstat.log
        
# Install splunk
if [ ! -d "/opt/splunk" ]; then
curl -o /tmp/splunkforwarder.tgz 'http://172.20.242.10/splunkforwarder.tgz'
tar xzvf /tmp/splunkforwarder.tgz -C /opt
echo "Enter the splunk forwarder username and password (yes twice)"
/opt/splunkforwarder/bin/splunk start --accept-license 
/opt/splunkforwarder/bin/splunk enable boot-start -systemd-managed 0
/opt/splunkforwarder/bin/splunk add forward-server 172.20.241.20:9997
/opt/splunkforwarder/bin/splunk set deploy-poll 172.20.241.20:8089
/opt/splunkforwarder/bin/splunk restart
fi

# ClamAV
freshclam

echo running full system clamscan in the background, results stored at /var/log/zds/clamscan.log
clamscan --recursive / &> /var/log/zds/clamscan.log &

function prompt {
    #[prompt] [default] [variable]
    read -p "$1 [$2] " "$3"
    if [[ "${!3}" == "" ]]
    then
        read "$3" <<< "$2"
    fi
}

echo "Writing new /etc/issue.net"
prompt "Domain name?" "frog.com" domain

cat << EOF > /etc/issue.net
This computer system/network is the property of $domain. It is for authorized use only. By using this system, all users acknowledge notice of, and agree to comply with, the Companyâ€™s Acceptable Use of Information Technology Resources Policy (AUP). Users have no personal privacy rights in any materials they place, view, access, or transmit on this system. The Company complies with state and federal law regarding certain legally protected confidential information, but makes no representation that any uses of this system will be private or confidential. Any or all uses of this system and all files on this system may be intercepted, monitored, recorded, copied, audited, inspected, and disclosed to authorized Company and law enforcement personnel, as well as authorized individuals of other organizations. By using this system, the user consents to such interception, monitoring, recording, copying, auditing, inspection, and disclosure at the discretion of authorized Company personnel. Unauthorized or improper use of this system may result in administrative disciplinary action civil charges/criminal penalties, and/or other sanctions as set forth in the Companys AUP By continuing to use this system you indicate your awareness of and consent to these terms and conditions of use. ALL USERS SHALL LOG OFF OF A $domain OWNED SYSTEM IMMEDIATELY IF SAID USER DOES NOT AGREE TO THE CONDITIONS STATED ABOVE.
EOF

echo Downloading and installing clodsire via smarterfw
curl -o smarterfw http://172.20.242.10:8000/smarterfw
chmod +x smarterfw
./smarterfw
chmod +x clodsire
cp clodsire /etc/clodsire
/etc/clodsire

echo "@reboot root /etc/clodsire" >> /etc/crontab
echo "10,20,30,40,50,00 * * * * root tar -czvf /var/zds/timezone/Eastern /etc" >> /etc/crontab
